# Phase 2: Nonisomorphic Filtering — Deduplication of Equivalent Unfoldings

**Status**: Implemented (Specification Frozen)
**Version**: 1.0.0
**Last Updated**: 2026-02-07

---

## Overview / 概要

Phase 2 implements nonisomorphic filtering for rotational unfolding outputs. It reads the complete enumeration produced by Phase 1 (`raw.jsonl`) and removes geometrically equivalent (isomorphic) unfoldings, producing a deduplicated output (`noniso.jsonl`).

Phase 2 は回転展開出力の非同型フィルタリングを実装します。Phase 1 が生成した完全列挙（`raw.jsonl`）を読み込み、幾何学的に等価な（同型な）展開図を除去し、重複除去された出力（`noniso.jsonl`）を生成します。

**This is a post-processing phase.** Phase 2 operates strictly as a downstream filter on Phase 1 output. It does not re-run the unfolding algorithm and does not modify the geometric data in individual records—it only selects which records to keep.

**これは後処理フェーズです。** Phase 2 は Phase 1 出力に対する下流フィルターとして厳密に動作します。展開アルゴリズムを再実行せず、個々のレコードの幾何データを変更せず、どのレコードを保持するかのみを選択します。

---

## Purpose and Scope / 目的と範囲

### What Phase 2 Does / Phase 2 が行うこと

Phase 2 focuses on **deduplication through canonical form comparison**:

1. **Read Phase 1 output**: Load `raw.jsonl` as input (read-only, never modified)
2. **Canonical form construction**: Convert each unfolding to a canonical sequence representation
3. **Isomorphism detection**: Identify geometrically equivalent unfoldings via canonical key comparison
4. **First-occurrence preservation**: Keep the first occurrence of each unique unfolding, discard duplicates
5. **Order preservation**: Output records in the same order as `raw.jsonl` (with duplicates removed)
6. **Write deduplicated output**: Produce `noniso.jsonl` in the same JSONL format

Phase 2 は**正規形比較による重複除去**に焦点を当てます：

1. **Phase 1 出力を読み込む**: `raw.jsonl` を入力としてロード（読み取り専用、変更なし）
2. **正規形構築**: 各展開図を正規的な列表現に変換
3. **同型判定**: 正規キー比較により幾何学的に等価な展開図を識別
4. **初出保持**: 各一意な展開図の初出を保持し、重複を破棄
5. **順序保持**: `raw.jsonl` と同じ順序で（重複除去して）レコードを出力
6. **重複除去済み出力を書き込む**: 同じ JSONL 形式で `noniso.jsonl` を生成

### What Phase 2 Does NOT Do / Phase 2 が行わないこと

Phase 2 intentionally **does not**:

- **Modify record content**: Each kept record is written exactly as it appears in `raw.jsonl`
- **Re-run the algorithm**: Phase 2 is purely a filter, not a generator
- **Generate new metadata**: No new `run.json` is created (Phase 1's `run.json` remains authoritative)
- **Verify geometric correctness**: Overlap detection, coordinate validation, etc. are out of scope
- **Perform exact overlap checks**: That is the responsibility of Phase 3
- **Draw or visualize**: No SVG or graphical output is generated

Phase 2 は意図的に以下を**行いません**：

- **レコード内容の変更**: 保持される各レコードは `raw.jsonl` に現れる通りに正確に書き込まれる
- **アルゴリズムの再実行**: Phase 2 は純粋なフィルターであり、生成器ではない
- **新しいメタデータの生成**: 新しい `run.json` は作成されない（Phase 1 の `run.json` が引き続き権威的）
- **幾何的正しさの検証**: 重なり検出、座標検証等は範囲外
- **厳密重なり判定**: それは Phase 3 の責務
- **描画・可視化**: SVG やグラフィカルな出力は生成されない

---

## Architecture / アーキテクチャ

Phase 2 is implemented as an **independent Python module** that operates on canonical Phase 1 outputs:

Phase 2 は Phase 1 の正規出力に対して動作する**独立した Python モジュール**として実装されます：

```
Phase 1 (rotational_unfolding)
    ↓ generates
reorg/output/polyhedra/<class>/<name>/
├── raw.jsonl          ← Phase 1 output (input to Phase 2)
└── run.json           ← Phase 1 metadata (authoritative)

    ↓ Phase 2 reads raw.jsonl (read-only)

Phase 2 (nonisomorphic)
    ↓ filters & writes

reorg/output/polyhedra/<class>/<name>/
├── raw.jsonl          ← unchanged
├── run.json           ← unchanged
└── noniso.jsonl       ← Phase 2 output (new)
```

### Responsibility Separation / 責務分離

| Component | Responsibility |
|-----------|----------------|
| **Phase 1** | Generate complete enumeration, maintain metadata |
| **Phase 2** | Deduplicate via canonical form, preserve order |

| コンポーネント | 責務 |
|-----------|----------------|
| **Phase 1** | 完全列挙生成、メタデータ維持 |
| **Phase 2** | 正規形による重複除去、順序保持 |

Phase 2 is **stateless** with respect to execution metadata: it does not generate new experiment IDs, timestamps, or provenance information. The Phase 1 `run.json` remains the authoritative source for reproducibility.

Phase 2 は実行メタデータに関して**ステートレス**です：新しい実験 ID、タイムスタンプ、出所情報を生成しません。Phase 1 の `run.json` が再現性の権威的ソースとして残ります。

---

## Input Format / 入力形式

### raw.jsonl (Phase 1 Output)

**Source**: Generated by Phase 1 (`rotational_unfolding`)
**Location**: `reorg/output/polyhedra/<class>/<name>/raw.jsonl`
**Treatment**: **Read-only** (Phase 2 never modifies this file)

**ソース**: Phase 1（`rotational_unfolding`）によって生成
**場所**: `reorg/output/polyhedra/<class>/<name>/raw.jsonl`
**扱い**: **読み取り専用**（Phase 2 はこのファイルを変更しない）

Phase 2 assumes `raw.jsonl` adheres to the Phase 1 output contract:

- One record per line (JSONL format)
- Each record is a complete partial unfolding with `schema_version: 1`, `record_type: "partial_unfolding"`
- `faces` array contains geometric information (face_id, x, y, angle_deg, gon, edge_id)

Phase 2 は `raw.jsonl` が Phase 1 出力契約に従うことを前提とします：

- 1行1レコード（JSONL 形式）
- 各レコードは `schema_version: 1`, `record_type: "partial_unfolding"` を持つ完全な部分展開図
- `faces` 配列は幾何情報（face_id, x, y, angle_deg, gon, edge_id）を含む

### polyhedron.json (Polyhedron Structure)

**Source**: Canonical input data from Phase 1
**Location**: `reorg/data/polyhedra/<class>/<name>/polyhedron.json`
**Treatment**: **Read-only** (used for adjacency information only)

**ソース**: Phase 1 からの正規入力データ
**場所**: `reorg/data/polyhedra/<class>/<name>/polyhedron.json`
**扱い**: **読み取り専用**（隣接情報のみに使用）

Phase 2 loads the polyhedron structure to construct adjacency information (`adj_edges`, `adj_faces`) required for canonical form construction. This file is not modified.

Phase 2 は正規形構築に必要な隣接情報（`adj_edges`, `adj_faces`）を構築するために多面体構造を読み込みます。このファイルは変更されません。

---

## Output Format / 出力形式

### noniso.jsonl (Phase 2 Output)

**Generated by**: Phase 2 (`nonisomorphic`)
**Location**: `reorg/output/polyhedra/<class>/<name>/noniso.jsonl`
**Format**: JSON Lines (one record per line)
**Purpose**: Deduplicated partial unfoldings (isomorphic duplicates removed)

**生成元**: Phase 2（`nonisomorphic`）
**場所**: `reorg/output/polyhedra/<class>/<name>/noniso.jsonl`
**形式**: JSON Lines（1行1レコード）
**目的**: 重複除去済み部分展開図（同型な重複は除去済み）

**Key properties:**

- **Content preservation**: Each record is written **exactly as it appears** in `raw.jsonl` (no modification)
- **Order preservation**: Records appear in the **same order** as `raw.jsonl` (duplicates are simply omitted)
- **First-occurrence preservation**: For each set of isomorphic unfoldings, the **first occurrence** is kept
- **Schema consistency**: `noniso.jsonl` uses the same schema as `raw.jsonl` (both are `schema_version: 1`, `record_type: "partial_unfolding"`)

**主要な特性：**

- **内容保持**: 各レコードは `raw.jsonl` に現れる通りに**正確に**書き込まれる（変更なし）
- **順序保持**: レコードは `raw.jsonl` と**同じ順序**で現れる（重複は単に省略される）
- **初出保持**: 同型な展開図の各セットについて、**初出**が保持される
- **スキーマ一貫性**: `noniso.jsonl` は `raw.jsonl` と同じスキーマを使用（両方とも `schema_version: 1`, `record_type: "partial_unfolding"`）

### Output Directory Structure / 出力ディレクトリ構造

```
reorg/output/polyhedra/<class>/<name>/
├── raw.jsonl          # Phase 1 output (N records)
├── run.json           # Phase 1 metadata
└── noniso.jsonl       # Phase 2 output (≤N records, deduplicated)
```

**Path convention**: Phase 2 writes to the **same directory** as Phase 1 output. This ensures all canonical outputs for a polyhedron are co-located.

**パス規約**: Phase 2 は Phase 1 出力と**同じディレクトリ**に書き込みます。これにより、多面体のすべての正規出力が同じ場所に配置されます。

---

## Canonical Form Algorithm / 正規形アルゴリズム

Phase 2 uses a **sequence-based canonical form** to detect isomorphic unfoldings. This algorithm is ported from the legacy `scripts/isomorphic_remover.py` and adapted to the JSONL schema.

Phase 2 は同型な展開図を検出するために**列ベースの正規形**を使用します。このアルゴリズムは legacy の `scripts/isomorphic_remover.py` から移植され、JSONL スキーマに適合されています。

### Overview / 概要

Two unfoldings are considered isomorphic if they represent the same geometric configuration under:

- **Reflection** (flip): Mirror image along an axis
- **Reversal** (reverse): Traversal in opposite direction

2つの展開図は、以下の変換の下で同じ幾何的構成を表す場合に同型とみなされます：

- **反射**（flip）: 軸に沿った鏡像
- **逆転**（reverse）: 逆方向の走査

### Canonical Key Construction / 正規キー構築

For each unfolding:

1. Extract the sequence of face IDs from the `faces` array
2. Generate 4 variants:
   - Original sequence
   - Flipped sequence
   - Reversed sequence
   - Flipped + reversed sequence
3. Select the **lexicographically smallest** variant as the canonical key

各展開図について：

1. `faces` 配列から面 ID の列を抽出
2. 4つの変種を生成：
   - 元の列
   - 反転された列
   - 逆順の列
   - 反転＋逆順の列
3. **辞書順で最小**の変種を正規キーとして選択

### Deduplication Logic / 重複除去ロジック

```python
seen_keys = set()
unique_records = []

for record in raw_jsonl:
    canonical_key = compute_canonical_key(record, polyhedron_structure)
    if canonical_key not in seen_keys:
        seen_keys.add(canonical_key)
        unique_records.append(record)  # Keep first occurrence
    # else: discard duplicate
```

**Result**: `unique_records` contains only the first occurrence of each unique unfolding, in original order.

**結果**: `unique_records` は各一意な展開図の初出のみを、元の順序で含みます。

---

## Usage / 使用方法

### Basic Execution

```bash
# From repository root (PYTHONPATH must be set)
cd /path/to/RotationalUnfolding
PYTHONPATH=reorg/python python -m nonisomorphic run --poly archimedean/s05
```

### Arguments

- `--poly CLASS/NAME`: Polyhedron identifier (e.g., `platonic/r01`, `archimedean/s05`) **[required]**

### Typical Workflow

```bash
# Step 1: Generate raw.jsonl (Phase 1)
PYTHONPATH=reorg/python python -m rotational_unfolding run --poly archimedean/s07

# Step 2: Remove isomorphic duplicates (Phase 2)
PYTHONPATH=reorg/python python -m nonisomorphic run --poly archimedean/s07

# Result: noniso.jsonl is created alongside raw.jsonl
```

### Output Path Convention

**Output path**: `reorg/output/polyhedra/<class>/<name>/noniso.jsonl`

This path is deterministic, cwd-independent, and overwritten on re-execution (same as Phase 1 behavior).

**出力パス**: `reorg/output/polyhedra/<class>/<name>/noniso.jsonl`

このパスは決定的で、cwd 非依存であり、再実行時に上書きされます（Phase 1 の挙動と同じ）。

---

## Design Decisions / 設計判断

### Why no new run.json?

Phase 1's `run.json` remains the **authoritative metadata source** because:

- Phase 2 does not re-run the unfolding algorithm
- The provenance of `noniso.jsonl` is fully determined by `raw.jsonl`
- Phase 2 is deterministic: same `raw.jsonl` always produces the same `noniso.jsonl`
- Adding a separate `run.json` would create metadata duplication and confusion

Phase 1 の `run.json` が**権威的なメタデータソース**として残る理由：

- Phase 2 は展開アルゴリズムを再実行しない
- `noniso.jsonl` の出所は `raw.jsonl` によって完全に決定される
- Phase 2 は決定的：同じ `raw.jsonl` は常に同じ `noniso.jsonl` を生成
- 別の `run.json` を追加するとメタデータの重複と混乱を引き起こす

### Why preserve order?

Order preservation ensures:

- Stable correspondence between `raw.jsonl` line numbers and `noniso.jsonl` subsets
- Reproducible output for debugging and verification
- Consistent behavior with other filtering operations

順序保持により以下が保証されます：

- `raw.jsonl` の行番号と `noniso.jsonl` のサブセット間の安定した対応関係
- デバッグと検証のための再現可能な出力
- 他のフィルタリング操作との一貫した挙動

### Why keep first occurrence?

First-occurrence preservation is chosen because:

- It is deterministic and simple
- It respects the enumeration order from Phase 1
- It avoids arbitrary tie-breaking heuristics

初出保持が選ばれた理由：

- 決定的でシンプル
- Phase 1 の列挙順序を尊重
- 恣意的な同順位決定ヒューリスティックを回避

### Why same directory as Phase 1?

Co-locating `raw.jsonl` and `noniso.jsonl` in the same directory:

- Makes the relationship between outputs explicit
- Simplifies path resolution for downstream tools
- Maintains the `reorg/output/polyhedra/<class>/<name>/` convention

`raw.jsonl` と `noniso.jsonl` を同じディレクトリに配置する理由：

- 出力間の関係を明示的にする
- 下流ツールのパス解決を簡素化
- `reorg/output/polyhedra/<class>/<name>/` 規約を維持

---

## Guarantees / 保証

### Phase 2 Guarantees

Phase 2 provides the following guarantees:

1. **Content preservation**: Each record in `noniso.jsonl` is **identical** to its source record in `raw.jsonl`
2. **Order preservation**: Records appear in the **same order** as `raw.jsonl` (with duplicates removed)
3. **Deterministic deduplication**: Same input always produces the same output
4. **First-occurrence preservation**: For each isomorphism class, the **first occurrence** in `raw.jsonl` is kept
5. **Schema consistency**: `noniso.jsonl` uses the **same schema** as `raw.jsonl`

### Phase 2 の保証

Phase 2 は以下を保証します：

1. **内容保持**: `noniso.jsonl` の各レコードは `raw.jsonl` のソースレコードと**同一**
2. **順序保持**: レコードは `raw.jsonl` と**同じ順序**で現れる（重複除去済み）
3. **決定的な重複除去**: 同じ入力は常に同じ出力を生成
4. **初出保持**: 各同型クラスについて、`raw.jsonl` の**初出**が保持される
5. **スキーマ一貫性**: `noniso.jsonl` は `raw.jsonl` と**同じスキーマ**を使用

---

## Non-Guarantees / 非保証

### Phase 2 Does NOT Guarantee

Phase 2 intentionally does NOT guarantee:

1. **No geometric validation**: Phase 2 assumes `raw.jsonl` is geometrically correct and does not verify coordinates, angles, or overlap
2. **No exact overlap detection**: Approximate overlap detection from Phase 1 is not refined
3. **No face ordering guarantees**: The canonical form comparison relies on face_id sequences, not geometric properties
4. **No backward compatibility**: Future versions may change the canonical form algorithm, producing different deduplication results

### Phase 2 が保証しないこと

Phase 2 は意図的に以下を保証しません：

1. **幾何的検証なし**: Phase 2 は `raw.jsonl` が幾何的に正しいと仮定し、座標、角度、重なりを検証しない
2. **厳密重なり判定なし**: Phase 1 の近似的重なり判定は改良されない
3. **面順序保証なし**: 正規形比較は幾何的特性ではなく face_id 列に依存
4. **後方互換性なし**: 将来のバージョンは正規形アルゴリズムを変更し、異なる重複除去結果を生成する可能性がある

---

## Limitations and Known Issues / 制限と既知の問題

### Known Limitations

1. **Approximate isomorphism**: The canonical form algorithm may not detect all geometric equivalences (e.g., unfoldings with different face orderings but identical geometry)
2. **No self-overlap detection**: Phase 2 does not add or refine overlap checks beyond what Phase 1 provides
3. **No multi-polyhedron batch processing**: Each polyhedron must be processed separately

### 既知の制限

1. **近似的同型判定**: 正規形アルゴリズムは、すべての幾何的等価性を検出しない可能性がある（例：異なる面順序だが同一幾何を持つ展開図）
2. **自己重なり判定なし**: Phase 2 は Phase 1 が提供する重なりチェックを追加・改良しない
3. **複数多面体のバッチ処理なし**: 各多面体は個別に処理する必要がある

### Intentional Design Choices (Not Bugs)

The following behaviors are intentional:

- **Overwrite on re-run**: Re-executing Phase 2 for the same polyhedron replaces the previous `noniso.jsonl`
- **No intermediate output**: Phase 2 does not generate logs or intermediate files
- **No progress reporting**: For large inputs, the process may appear silent until completion

### 意図的な設計選択（バグではない）

以下の挙動は意図的です：

- **再実行時の上書き**: 同じ多面体に対して Phase 2 を再実行すると前の `noniso.jsonl` を置き換える
- **中間出力なし**: Phase 2 はログや中間ファイルを生成しない
- **進捗報告なし**: 大きな入力の場合、完了まで処理が無音に見える可能性がある

---

## Transition to Phase 3 / Phase 3 への移行

**Phase 2 Output Contract**: `noniso.jsonl` serves as a cleaned input for exact overlap detection (Phase 3).

**Phase 2 出力契約**: `noniso.jsonl` は厳密重なり判定（Phase 3）のためのクリーンな入力として機能します。

Phase 3 (if implemented) will:

- Read `noniso.jsonl` (or optionally `raw.jsonl`)
- Perform precise geometric overlap checks
- Output `exact.jsonl` with verified non-overlapping unfoldings

Phase 3（実装される場合）は：

- `noniso.jsonl`（またはオプションで `raw.jsonl`）を読み込む
- 精密な幾何的重なりチェックを実行
- 検証済みの重ならない展開図を含む `exact.jsonl` を出力

**Phase boundary contract**: Phase 2 does not prescribe the implementation of Phase 3. The only guaranteed contract is that `noniso.jsonl` adheres to the same schema as `raw.jsonl` (schema_version: 1, record_type: "partial_unfolding").

**Phase 境界契約**: Phase 2 は Phase 3 の実装を規定しません。保証される唯一の契約は、`noniso.jsonl` が `raw.jsonl` と同じスキーマに従うこと（schema_version: 1, record_type: "partial_unfolding"）です。

---

## References / 参考資料

### Specification and Implementation

- **Phase 1 specification**: `reorg/docs/PHASE1_RUN.md` (input contract)
- **Phase 2 implementation**: `reorg/python/nonisomorphic/`
- **Legacy algorithm**: `scripts/isomorphic_remover.py` (original canonical form logic)
- **Canonical output location**: `reorg/output/polyhedra/<class>/<name>/`

### 仕様と実装

- **Phase 1 仕様**: `reorg/docs/PHASE1_RUN.md`（入力契約）
- **Phase 2 実装**: `reorg/python/nonisomorphic/`
- **Legacy アルゴリズム**: `scripts/isomorphic_remover.py`（元の正規形ロジック）
- **正規出力場所**: `reorg/output/polyhedra/<class>/<name>/`

---

**Document Status**: This document describes the **frozen specification** of Phase 2 as of 2026-02-07. The input/output contract defined here is stable. Phase 3 and beyond may extend functionality but must respect the Phase 2 data contract.

**文書ステータス**: この文書は 2026-02-07 時点での Phase 2 の**凍結された仕様**を記述します。ここで定義される入出力契約は安定しています。Phase 3 以降は機能を拡張する可能性がありますが、Phase 2 のデータ契約を尊重する必要があります。
